<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Episode 1 · The whole story (60 min) | NSPFRNP</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: #0a0a0c;
      color: #e8e8e8;
      overflow: hidden;
    }
    .top-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 20;
      padding: 0.5rem 1rem;
      background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
      display: flex;
      align-items: center;
      justify-content: space-between;
      pointer-events: none;
    }
    .top-bar a, .top-bar button { pointer-events: auto; }
    .top-bar a {
      color: #d4af37;
      text-decoration: none;
      font-size: 0.9rem;
    }
    .top-bar a:hover { text-decoration: underline; }
    .top-bar .label { font-size: 0.85rem; color: rgba(255,255,255,0.7); }
    .slide-wrap {
      width: 100%;
      height: 100%;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .slide-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #111;
    }
    .slide-image.empty {
      background: linear-gradient(145deg, #1a1a2e 0%, #0f0c08 100%);
    }
    .slide-content {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 1.5rem 1.5rem calc(1.5rem + env(safe-area-inset-bottom));
      background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
      text-align: center;
    }
    .slide-title {
      font-size: 0.75rem;
      letter-spacing: 0.2em;
      color: rgba(212, 175, 55, 0.8);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
    }
    .caption-stream {
      font-size: clamp(0.95rem, 2.2vw, 1.15rem);
      color: rgba(255,255,255,0.95);
      line-height: 1.6;
      max-width: 720px;
      margin: 0 auto;
      min-height: 2.5em;
    }
    .progress-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      height: 3px;
      background: rgba(212, 175, 55, 0.4);
      z-index: 25;
      transition: width 0.1s linear;
    }
    .controls {
      position: fixed;
      bottom: calc(1rem + env(safe-area-inset-bottom));
      right: 1rem;
      z-index: 22;
      display: flex;
      gap: 0.5rem;
    }
    .controls button {
      padding: 0.5rem 0.75rem;
      background: rgba(212, 175, 55, 0.2);
      border: 1px solid rgba(212, 175, 55, 0.5);
      border-radius: 6px;
      color: #fef3c7;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .controls button:hover {
      background: rgba(212, 175, 55, 0.35);
    }
    .fullscreen .top-bar,
    .fullscreen .controls { opacity: 0.6; }
    .fullscreen .top-bar:hover,
    .fullscreen .controls:hover { opacity: 1; }
  </style>
</head>
<body>
  <div class="progress-bar" id="progress" style="width: 0%"></div>

  <div class="top-bar">
    <a href="my-whiteboard.html">← My Whiteboard</a>
    <a href="soundtrack.html">Soundtrack</a>
    <span class="label" id="slideCounter">1 / 1</span>
  </div>

  <div class="slide-wrap">
    <img class="slide-image empty" id="slideImage" src="" alt="" />
    <div id="slideBg" style="position:absolute;inset:0;pointer-events:none;transition:background 2.5s ease;z-index:1;"></div>
    <div class="slide-content" style="z-index:2;">
      <div class="slide-title" id="slideLabel"></div>
      <div class="caption-stream" id="captionStream"></div>
    </div>
  </div>

  <div class="controls">
    <button type="button" id="btnPlay">Pause</button>
    <button type="button" id="btnFullscreen">Full screen</button>
  </div>

  <audio id="soundtrack" style="display:none"></audio>

  <script>
    (function () {
      const DURATION_SEC = 10;
      const SLIDES_TOTAL = 120;
      const SLIDES_PER_SEGMENT = 17;

      // Per-segment Unsplash image pools — visual variety across the 7 acts
      var SEG_IMAGES = [
        // 0 · Intro / Invitation
        ['https://images.unsplash.com/photo-1462331940025-496dfbfc7564?w=1400&q=80',
         'https://images.unsplash.com/photo-1419242902214-272b3f66ee7a?w=1400&q=80',
         'https://images.unsplash.com/photo-1446941611757-91d2c3bd3d45?w=1400&q=80'],
        // 1 · Seed · 1493
        ['https://images.unsplash.com/photo-1534271057238-c2c170a76672?w=1400&q=80',
         'https://images.unsplash.com/photo-1505118380757-91f5f5632de0?w=1400&q=80',
         'https://images.unsplash.com/photo-1521336575822-6da63fb45455?w=1400&q=80'],
        // 2 · Singularities
        ['https://images.unsplash.com/photo-1530882149046-4fa9d422e40f?w=1400&q=80',
         'https://images.unsplash.com/photo-1565992441121-4367b2a43598?w=1400&q=80',
         'https://images.unsplash.com/photo-1483728642387-6c3bdd6c93e5?w=1400&q=80'],
        // 3 · Journey
        ['https://images.unsplash.com/photo-1506157786151-b8491531f063?w=1400&q=80',
         'https://images.unsplash.com/photo-1529156069898-49953e39b3ac?w=1400&q=80',
         'https://images.unsplash.com/photo-1527525443983-6e60c75fff46?w=1400&q=80'],
        // 4 · Now · Mission
        ['https://images.unsplash.com/photo-1529686342540-1b43aec0df75?w=1400&q=80',
         'https://images.unsplash.com/photo-1519682577862-22b62b24e493?w=1400&q=80',
         'https://images.unsplash.com/photo-1518562180175-34a163b1a9a6?w=1400&q=80'],
        // 5 · Edge · Sol-V
        ['https://images.unsplash.com/photo-1511884642898-4c92249e20b6?w=1400&q=80',
         'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1400&q=80',
         'https://images.unsplash.com/photo-1470252649378-9c29740c9fa8?w=1400&q=80'],
        // 6 · We are the champions
        ['https://images.unsplash.com/photo-1514525253161-7a46d19cd819?w=1400&q=80',
         'https://images.unsplash.com/photo-1492684223066-81342ee5ff30?w=1400&q=80',
         'https://images.unsplash.com/photo-1540575467063-178a50c2df87?w=1400&q=80']
      ];

      var SEG_OVERLAYS = [
        'linear-gradient(160deg,rgba(4,2,18,0.82) 0%,rgba(12,8,36,0.65) 100%)',
        'linear-gradient(160deg,rgba(2,4,18,0.82) 0%,rgba(4,12,32,0.65) 100%)',
        'linear-gradient(160deg,rgba(8,4,22,0.82) 0%,rgba(16,8,40,0.65) 100%)',
        'linear-gradient(160deg,rgba(18,8,2,0.82) 0%,rgba(28,12,4,0.65) 100%)',
        'linear-gradient(160deg,rgba(18,2,2,0.85) 0%,rgba(28,4,4,0.7) 100%)',
        'linear-gradient(160deg,rgba(0,12,8,0.8)  0%,rgba(0,22,14,0.65) 100%)',
        'linear-gradient(160deg,rgba(14,10,0,0.78) 0%,rgba(24,18,0,0.62) 100%)'
      ];

      var SEG_ACCENTS = ['#a78bfa','#7dd3fc','#c4b5fd','#fb923c','#f87171','#34d399','#fde68a'];

      var slides = [], scriptLines = [];
      var index = 0, playing = true, tick = 0, elapsedSec = 0;
      var tickInterval = null, tickerInterval = null;
      var tracksByPlaylist = {}, currentSegment = -1, segmentTrackIndex = 0;
      var segImgIndex = 0;

      // Ticker tape state
      var tickerWords = [], tickerPos = 0;

      var audioEl = document.getElementById('soundtrack');
      var imgEl   = document.getElementById('slideImage');
      var bgEl    = document.getElementById('slideBg');
      var captEl  = document.getElementById('captionStream');
      var labelEl = document.getElementById('slideLabel');
      var ctrEl   = document.getElementById('slideCounter');

      function getSegment(i) {
        if (i <= 0) return 0;
        if (i >= SLIDES_TOTAL - 1) return 6;
        return Math.min(6, Math.floor(i / SLIDES_PER_SEGMENT));
      }

      function audioPath(t) {
        var f = (t.file || t.File || '');
        if (f.indexOf('io/') === 0) f = 'assets/audio/' + f.substring(3);
        return f ? '../' + f.replace(/\\/g, '/') : '';
      }

      function playSegmentTrack(seg, idx) {
        var id = 'playlist-' + (Math.min(seg, 6) + 1);
        var list = tracksByPlaylist[id];
        if (!list || !list.length) return;
        idx = idx % list.length;
        var src = audioPath(list[idx]);
        if (!src) return;
        audioEl.src = src;
        audioEl.play().catch(function () {});
        segmentTrackIndex = idx;
      }

      // ── TICKER TAPE ENGINE ─────────────────────────────────────
      function startTicker(line) {
        if (tickerInterval) clearInterval(tickerInterval);
        tickerWords = (line || '').split(' ').filter(Boolean);
        tickerPos = 0;
        if (captEl) captEl.textContent = '';
        if (!tickerWords.length) return;
        // Spread reveal evenly across the 10-second slide (budget ~80% of time)
        var msPerWord = Math.min(260, Math.floor((DURATION_SEC * 800) / tickerWords.length));
        tickerInterval = setInterval(function () {
          if (!playing) return;
          if (tickerPos < tickerWords.length) {
            var shown = tickerWords.slice(0, tickerPos + 1).join(' ');
            if (captEl) captEl.textContent = shown;
            tickerPos++;
          } else {
            clearInterval(tickerInterval);
          }
        }, msPerWord);
      }

      function getScriptLine() {
        if (!scriptLines.length) return '';
        var li = Math.floor(elapsedSec / DURATION_SEC) % scriptLines.length;
        return scriptLines[li] || '';
      }

      // ── RENDER ────────────────────────────────────────────────
      function render() {
        if (!slides.length) return;
        var s = slides[index];
        var seg = getSegment(index);
        var pool = SEG_IMAGES[Math.min(seg, SEG_IMAGES.length - 1)];

        // Image: use slide's local image if it's a confirmed interfaces/assets/ path
        var localPath = (s.image || '').replace(/^interfaces\//, '');
        var useLocal = localPath && localPath.indexOf('assets/') === 0 && localPath.indexOf('assets/images/') === -1;

        if (useLocal) {
          imgEl.src = localPath;
          imgEl.classList.remove('empty');
        } else {
          // Use segment Unsplash pool — cycle through all 3 images
          imgEl.src = pool[segImgIndex % pool.length];
          imgEl.classList.remove('empty');
        }

        // Background overlay per segment
        if (bgEl) bgEl.style.background = SEG_OVERLAYS[Math.min(seg, SEG_OVERLAYS.length - 1)];

        // Accent color on progress bar
        var accent = SEG_ACCENTS[Math.min(seg, SEG_ACCENTS.length - 1)];
        document.getElementById('progress').style.background = accent;

        // Labels
        labelEl.textContent = s.title || '';
        labelEl.style.color = accent;
        ctrEl.textContent = (index + 1) + ' / ' + slides.length;

        tick = 0;
        updateProgress();

        // Segment change: new music + reset pool index
        if (seg !== currentSegment) {
          currentSegment = seg;
          segmentTrackIndex = 0;
          segImgIndex = 0;
          if (playing) playSegmentTrack(seg, 0);
        } else {
          segImgIndex++;
        }

        // Start ticker tape for this slide's script line
        startTicker(getScriptLine());
      }

      function updateProgress() {
        var pct = (tick / DURATION_SEC) * 100;
        document.getElementById('progress').style.width = pct + '%';
      }

      function startTick() {
        if (tickInterval) clearInterval(tickInterval);
        tickInterval = setInterval(function () {
          if (!playing) return;
          tick++;
          elapsedSec++;
          updateProgress();
          if (tick >= DURATION_SEC) {
            index = (index + 1) % slides.length;
            render();
          }
        }, 1000);
      }

      // ── LOAD ──────────────────────────────────────────────────
      function loadAll() {
        Promise.all([
          fetch('../data/episode-1-slides.json').then(function (r) { return r.json(); }),
          fetch('../data/audio-assets.json').then(function (r) { return r.json(); }),
          fetch('../data/episode-1-script.json').then(function (r) { return r.json(); }).catch(function () { return {}; })
        ]).then(function (res) {
          var slideData = res[0], audioData = res[1], scriptData = res[2];
          slides = slideData.slides || [];
          if (!slides.length) {
            for (var i = 0; i < SLIDES_TOTAL; i++) slides.push({ id: 'slide-' + i, title: '', duration_sec: DURATION_SEC, image: '' });
          }
          scriptLines = (scriptData.lines && scriptData.lines.length) ? scriptData.lines : ['Episode 1 · The Golden Heart Origin Story.'];
          var tracks = audioData.tracks || [];
          for (var p = 1; p <= 7; p++) {
            var pid = 'playlist-' + p;
            tracksByPlaylist[pid] = tracks.filter(function (t) { return (t.source_playlist || '') === pid; });
          }
          audioEl.addEventListener('ended', function () {
            playSegmentTrack(getSegment(index), segmentTrackIndex + 1);
          });
          render();
          startTick();
        }).catch(function () {
          // Fallback: use image pools + basic script
          slides = [];
          for (var i = 0; i < SLIDES_TOTAL; i++) slides.push({ id: 'slide-' + i, title: 'Episode 1', duration_sec: DURATION_SEC, image: '' });
          scriptLines = ['Episode 1 · The Golden Heart Origin Story · SING 9 · NSPFRNP'];
          render();
          startTick();
        });
      }

      // ── CONTROLS ──────────────────────────────────────────────
      document.getElementById('btnPlay').addEventListener('click', function () {
        playing = !playing;
        this.textContent = playing ? 'Pause' : 'Play';
        if (playing) { audioEl.play().catch(function () {}); }
        else { audioEl.pause(); }
      });

      document.getElementById('btnFullscreen').addEventListener('click', function () {
        if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(function () {});
        else document.exitFullscreen();
      });

      document.addEventListener('keydown', function (e) {
        if (e.key === ' ' || e.key === 'k') {
          e.preventDefault();
          playing = !playing;
          document.getElementById('btnPlay').textContent = playing ? 'Pause' : 'Play';
        }
        if (e.key === 'Escape' && document.fullscreenElement) document.exitFullscreen();
      });

      loadAll();
    })();
  </script>
</body>
</html>
