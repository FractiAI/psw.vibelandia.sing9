<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Episode 1 · The whole story (60 min) | NSPFRNP</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: #0a0a0c;
      color: #e8e8e8;
      overflow: hidden;
    }
    .top-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 20;
      padding: 0.5rem 1rem;
      background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
      display: flex;
      align-items: center;
      justify-content: space-between;
      pointer-events: none;
    }
    .top-bar a, .top-bar button { pointer-events: auto; }
    .top-bar a {
      color: #d4af37;
      text-decoration: none;
      font-size: 0.9rem;
    }
    .top-bar a:hover { text-decoration: underline; }
    .top-bar .label { font-size: 0.85rem; color: rgba(255,255,255,0.7); }
    .slide-wrap {
      width: 100%;
      height: 100%;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .slide-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #111;
    }
    .slide-image.empty {
      background: linear-gradient(145deg, #1a1a2e 0%, #0f0c08 100%);
    }
    .slide-content {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 1.5rem 1.5rem calc(1.5rem + env(safe-area-inset-bottom));
      background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
      text-align: center;
    }
    .slide-title {
      font-size: 0.75rem;
      letter-spacing: 0.2em;
      color: rgba(212, 175, 55, 0.8);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
    }
    .caption-stream {
      font-size: clamp(0.95rem, 2.2vw, 1.15rem);
      color: rgba(255,255,255,0.95);
      line-height: 1.6;
      max-width: 720px;
      margin: 0 auto;
      min-height: 2.5em;
    }
    .progress-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      height: 3px;
      background: rgba(212, 175, 55, 0.4);
      z-index: 25;
      transition: width 0.1s linear;
    }
    .controls {
      position: fixed;
      bottom: calc(1rem + env(safe-area-inset-bottom));
      right: 1rem;
      z-index: 22;
      display: flex;
      gap: 0.5rem;
    }
    .controls button {
      padding: 0.5rem 0.75rem;
      background: rgba(212, 175, 55, 0.2);
      border: 1px solid rgba(212, 175, 55, 0.5);
      border-radius: 6px;
      color: #fef3c7;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .controls button:hover {
      background: rgba(212, 175, 55, 0.35);
    }
    .fullscreen .top-bar,
    .fullscreen .controls { opacity: 0.6; }
    .fullscreen .top-bar:hover,
    .fullscreen .controls:hover { opacity: 1; }
  </style>
</head>
<body>
  <div class="progress-bar" id="progress" style="width: 0%"></div>

  <div class="top-bar">
    <a href="my-whiteboard.html">← My Whiteboard</a>
    <a href="soundtrack.html">Soundtrack</a>
    <span class="label" id="slide-counter">1 / 1</span>
  </div>

  <div class="slide-wrap">
    <img class="slide-image empty" id="slideImage" src="" alt="" />
    <div class="slide-content">
      <div class="slide-title" id="slideLabel">Script stream</div>
      <div class="caption-stream" id="captionStream">Streaming the one-hour script. Captions run independently of images.</div>
    </div>
  </div>

  <div class="controls">
    <button type="button" id="btnPlay">Pause</button>
    <button type="button" id="btnFullscreen">Full screen</button>
  </div>

  <audio id="soundtrack" style="display:none"></audio>

  <script>
    (function () {
      const DURATION_SEC = 10;
      const SLIDES_TOTAL = 120;
      const SLIDES_PER_SEGMENT = 17;
      const SCRIPT_SEC_PER_LINE = 10;
      let slides = [];
      let scriptLines = [];
      let index = 0;
      let playing = true;
      let tick = 0;
      let elapsedSec = 0;
      let tickInterval = null;
      var tracksByPlaylist = {};
      var currentSegment = -1;
      var segmentTrackIndex = 0;
      var audioEl = document.getElementById('soundtrack');

      function audioPath(track) {
        var f = track.file || track.File || '';
        if (f.indexOf('io/') === 0) f = 'assets/audio/' + f.substring(3);
        return f ? '../' + f.replace(/\\/g, '/') : '';
      }

      function getSegment(slideIdx) {
        if (slideIdx <= 0) return 0;
        if (slideIdx >= SLIDES_TOTAL - 1) return 7;
        return Math.min(7, Math.floor(slideIdx / SLIDES_PER_SEGMENT));
      }

      function playSegmentTrack(seg, trackIdx) {
        var playlistId = 'playlist-' + (Math.min(seg, 6) + 1);
        var list = tracksByPlaylist[playlistId];
        if (!list || !list.length) return;
        trackIdx = trackIdx % list.length;
        var t = list[trackIdx];
        var src = audioPath(t);
        if (!src) return;
        audioEl.src = src;
        audioEl.play().catch(function () {});
        segmentTrackIndex = trackIdx;
      }

      function onAudioEnded() {
        var seg = getSegment(index);
        var playlistId = 'playlist-' + (seg + 1);
        var list = tracksByPlaylist[playlistId];
        if (!list || !list.length) return;
        playSegmentTrack(seg, segmentTrackIndex + 1);
      }

      function buildScriptLinesFromSegments(subtitles) {
        var lines = [];
        var perSegment = 45;
        for (var s = 0; s < (subtitles || []).length; s++) {
          for (var k = 0; k < perSegment; k++) lines.push(subtitles[s] || '');
        }
        return lines.length ? lines : ['Episode 1 · The whole story. Streaming script. 60 min.'];
      }

      function loadSlides() {
        Promise.all([
          fetch('../data/episode-1-slides.json').then(function (r) { return r.json(); }),
          fetch('../data/audio-assets.json').then(function (r) { return r.json(); }),
          fetch('../data/episode-1-script.json').then(function (r) { return r.json(); }).catch(function () { return {}; })
        ]).then(function (results) {
          var data = results[0];
          var audioData = results[1];
          var scriptData = results[2];
          var rawSlides = data.slides || [];
          var titles = data.segment_titles || [];
          var subtitles = data.segment_subtitles || [];
          scriptLines = (scriptData.lines && scriptData.lines.length) ? scriptData.lines : buildScriptLinesFromSegments(subtitles);
          if (rawSlides.length >= SLIDES_TOTAL) {
            slides = rawSlides;
          } else {
            slides = [];
            for (var i = 0; i < SLIDES_TOTAL; i++) {
              var seg = getSegment(i);
              slides.push({
                id: 'slide-' + i,
                title: titles[seg] || 'Episode 1',
                subtitle: subtitles[seg] || '',
                duration_sec: DURATION_SEC,
                image: (rawSlides[i] && rawSlides[i].image) ? rawSlides[i].image : ''
              });
            }
          }
          var tracks = audioData.tracks || [];
          for (var p = 1; p <= 7; p++) {
            var id = 'playlist-' + p;
            tracksByPlaylist[id] = tracks.filter(function (t) { return (t.source_playlist || '') === id; });
          }
          if (audioEl && !audioEl.onended) audioEl.addEventListener('ended', onAudioEnded);
          render();
          startTick();
        }).catch(function () {
          slides = [{ id: 'placeholder', title: 'Episode 1', subtitle: '60 min. Stream + images + soundtracks.', duration_sec: DURATION_SEC, image: '' }];
          scriptLines = ['Episode 1 · The whole story. Load data/episode-1-slides.json and episode-1-script.json.'];
          render();
          startTick();
        });
      }

      function render() {
        if (slides.length === 0) return;
        var s = slides[index];
        var img = document.getElementById('slideImage');
        if (s.image) {
          img.src = s.image;
          img.alt = s.title || '';
          img.classList.remove('empty');
        } else {
          img.src = '';
          img.alt = '';
          img.classList.add('empty');
        }
        document.getElementById('slideCounter').textContent = (index + 1) + ' / ' + slides.length;
        var sec = s.duration_sec != null ? s.duration_sec : DURATION_SEC;
        tick = 0;
        updateProgress(sec);
        var seg = getSegment(index);
        if (seg !== currentSegment) {
          currentSegment = seg;
          segmentTrackIndex = 0;
          if (playing) playSegmentTrack(seg, 0);
        }
        updateCaptionStream();
      }

      function updateCaptionStream() {
        var lineIndex = Math.floor(elapsedSec / SCRIPT_SEC_PER_LINE) % Math.max(1, scriptLines.length);
        var el = document.getElementById('captionStream');
        if (el && scriptLines.length) el.textContent = scriptLines[lineIndex] || '';
      }

      function updateProgress(sec) {
        var pct = sec ? (tick / sec) * 100 : 0;
        document.getElementById('progress').style.width = pct + '%';
      }

      function startTick() {
        if (tickInterval) clearInterval(tickInterval);
        var sec = (slides[index] && slides[index].duration_sec != null) ? slides[index].duration_sec : DURATION_SEC;
        tickInterval = setInterval(function () {
          if (!playing) return;
          tick += 1;
          elapsedSec += 1;
          updateProgress(sec);
          updateCaptionStream();
          if (tick >= sec) {
            index = (index + 1) % slides.length;
            render();
          }
        }, 1000);
      }

      document.getElementById('btnPlay').addEventListener('click', function () {
        playing = !playing;
        this.textContent = playing ? 'Pause' : 'Play';
        if (playing) audioEl.play().catch(function () {}); else audioEl.pause();
      });

      document.getElementById('btnFullscreen').addEventListener('click', function () {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen().catch(function () {});
        } else {
          document.exitFullscreen();
        }
      });

      document.addEventListener('keydown', function (e) {
        if (e.key === ' ' || e.key === 'k') {
          e.preventDefault();
          playing = !playing;
          document.getElementById('btnPlay').textContent = playing ? 'Pause' : 'Play';
        }
        if (e.key === 'Escape') {
          if (document.fullscreenElement) document.exitFullscreen();
        }
      });

      loadSlides();
    })();
  </script>
</body>
</html>
