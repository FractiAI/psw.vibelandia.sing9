<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Four-Layer Chess ¬∑ Carbon ‚Üí Crystalline ¬∑ HHL Singularity ¬∑ AI Opponent | SING 9</title>
  <meta name="description" content="9√ó9 chess across four stacked layers. Origin Possibility State. AI opponent. HHL Singularity Mode on Crystalline. Spin off new worlds."/>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#080810 0%,#0f0e1e 100%);color:#e8e8e8;min-height:100vh;padding:1.25rem;}
    .wrap{max-width:1060px;margin:0 auto;}
    .top-links{margin-bottom:1rem;font-size:0.82rem;}
    .top-links a{color:#00d4ff;text-decoration:none;margin-right:0.75rem;}
    h1{font-size:clamp(1.2rem,3.5vw,1.7rem);color:#d4af37;font-weight:800;margin-bottom:0.2rem;}
    .sub{font-size:0.82rem;color:#64748b;margin-bottom:1.25rem;}

    /* ‚îÄ‚îÄ ORIGIN POSSIBILITY STATE OVERLAY ‚îÄ‚îÄ */
    .possibility-overlay{
      position:fixed;inset:0;z-index:2000;
      background:radial-gradient(ellipse at 50% 50%, #0a0820 0%, #050510 100%);
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      text-align:center;padding:2rem;
      animation:fadeInOverlay 1.2s ease;
    }
    @keyframes fadeInOverlay{from{opacity:0;}to{opacity:1;}}
    .po-rings{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;}
    .po-ring{position:absolute;border-radius:50%;border:1px solid;animation:poRing 6s ease-in-out infinite;}
    .po-ring:nth-child(1){width:500px;height:500px;border-color:rgba(196,162,101,0.1);animation-delay:0s;}
    .po-ring:nth-child(2){width:380px;height:380px;border-color:rgba(192,192,192,0.08);animation-delay:1s;}
    .po-ring:nth-child(3){width:260px;height:260px;border-color:rgba(212,175,55,0.09);animation-delay:2s;}
    .po-ring:nth-child(4){width:140px;height:140px;border-color:rgba(168,230,240,0.1);animation-delay:3s;}
    @keyframes poRing{0%,100%{transform:scale(1);opacity:0.4;}50%{transform:scale(1.03);opacity:1;}}
    @media(max-width:500px){.po-ring:nth-child(1){width:280px;height:280px;}.po-ring:nth-child(2){width:210px;height:210px;}.po-ring:nth-child(3){width:140px;height:140px;}.po-ring:nth-child(4){width:70px;height:70px;}}
    .po-content{position:relative;z-index:2;max-width:580px;}
    .po-eyebrow{font-size:0.6rem;letter-spacing:0.35em;text-transform:uppercase;color:rgba(212,175,55,0.4);margin-bottom:1.5rem;}
    .po-title{font-size:clamp(1.6rem,5vw,2.8rem);font-weight:900;color:#fef3c7;line-height:1.1;margin-bottom:1.5rem;}
    .po-poetry{font-size:clamp(0.88rem,2vw,1.05rem);color:rgba(200,200,220,0.65);line-height:1.9;margin-bottom:2.5rem;font-style:italic;}
    .po-poetry strong{color:rgba(212,175,55,0.9);font-style:normal;}
    .po-poetry em{color:rgba(168,230,240,0.8);font-style:normal;}
    .po-diff{margin-bottom:2rem;}
    .po-diff-label{font-size:0.7rem;letter-spacing:0.2em;text-transform:uppercase;color:#64748b;margin-bottom:0.75rem;}
    .po-diff-btns{display:flex;gap:0.6rem;justify-content:center;flex-wrap:wrap;}
    .diff-btn{
      padding:0.55rem 1.1rem;border-radius:20px;border:1.5px solid;font-size:0.82rem;font-weight:700;
      cursor:pointer;transition:all 0.15s;background:transparent;
    }
    .diff-btn.active{box-shadow:0 0 16px rgba(212,175,55,0.3);}
    .diff-btn.match{color:#4ade80;border-color:rgba(74,222,128,0.4);}
    .diff-btn.match.active{background:rgba(74,222,128,0.12);}
    .diff-btn.ahead{color:#d4af37;border-color:rgba(212,175,55,0.4);}
    .diff-btn.ahead.active{background:rgba(212,175,55,0.12);}
    .diff-btn.mastery{color:#e879f9;border-color:rgba(232,121,249,0.4);}
    .diff-btn.mastery.active{background:rgba(232,121,249,0.12);}
    .po-begin-btn{
      padding:0.9rem 2.5rem;border-radius:30px;
      background:linear-gradient(135deg,rgba(196,162,101,0.2),rgba(212,175,55,0.15));
      border:2px solid rgba(212,175,55,0.5);color:#fef3c7;
      font-size:1rem;font-weight:800;cursor:pointer;letter-spacing:0.06em;
      transition:all 0.2s;
      animation:beginPulse 2.5s ease-in-out infinite;
    }
    .po-begin-btn:hover{background:linear-gradient(135deg,rgba(196,162,101,0.35),rgba(212,175,55,0.3));box-shadow:0 0 30px rgba(212,175,55,0.3);}
    @keyframes beginPulse{0%,100%{box-shadow:0 0 8px rgba(212,175,55,0.15);}50%{box-shadow:0 0 24px rgba(212,175,55,0.4);}}

    /* ‚îÄ‚îÄ AI PANEL (floating) ‚îÄ‚îÄ */
    .ai-panel{
      position:fixed;bottom:1.25rem;right:1.25rem;z-index:500;
      background:rgba(10,10,20,0.92);border:1.5px solid rgba(212,175,55,0.3);
      border-radius:12px;padding:0.75rem 1rem;min-width:200px;
      backdrop-filter:blur(8px);
    }
    .ai-panel-label{font-size:0.62rem;letter-spacing:0.18em;text-transform:uppercase;color:#64748b;margin-bottom:0.5rem;}
    .ai-diff-row{display:flex;gap:0.4rem;margin-bottom:0.4rem;}
    .ai-dbtn{
      flex:1;padding:0.3rem 0.4rem;border-radius:8px;border:1px solid;font-size:0.7rem;font-weight:700;
      cursor:pointer;transition:all 0.12s;text-align:center;
    }
    .ai-dbtn.m{color:#4ade80;border-color:rgba(74,222,128,0.3);background:transparent;}
    .ai-dbtn.m.active{background:rgba(74,222,128,0.15);border-color:rgba(74,222,128,0.6);}
    .ai-dbtn.a{color:#d4af37;border-color:rgba(212,175,55,0.3);background:transparent;}
    .ai-dbtn.a.active{background:rgba(212,175,55,0.15);border-color:rgba(212,175,55,0.6);}
    .ai-dbtn.ms{color:#e879f9;border-color:rgba(232,121,249,0.3);background:transparent;}
    .ai-dbtn.ms.active{background:rgba(232,121,249,0.15);border-color:rgba(232,121,249,0.6);}
    .ai-thinking{font-size:0.7rem;color:#64748b;min-height:1rem;font-style:italic;}
    .ai-thinking.active{color:#d4af37;animation:blink 1s step-end infinite;}
    @keyframes blink{50%{opacity:0;}}

    /* ‚îÄ‚îÄ HHL SINGULARITY OVERLAY ‚îÄ‚îÄ */
    .hhl-overlay{
      display:none;position:fixed;inset:0;z-index:1500;
      background:rgba(5,5,20,0.88);
      align-items:center;justify-content:center;flex-direction:column;
      text-align:center;padding:2rem;
      backdrop-filter:blur(4px);
    }
    .hhl-overlay.show{display:flex;animation:hhlFade 0.5s ease;}
    @keyframes hhlFade{from{opacity:0;transform:scale(0.95);}to{opacity:1;transform:scale(1);}}
    .hhl-burst{font-size:3.5rem;margin-bottom:1rem;animation:burst 0.8s ease;}
    @keyframes burst{0%{transform:scale(0.3) rotate(-20deg);opacity:0;}60%{transform:scale(1.15) rotate(5deg);}100%{transform:scale(1) rotate(0);opacity:1;}}
    .hhl-title{font-size:clamp(1.5rem,4vw,2.5rem);font-weight:900;margin-bottom:0.5rem;
      background:linear-gradient(135deg,#a8e6f0,#e879f9,#d4af37);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
    .hhl-sub{font-size:0.9rem;color:#94a3b8;max-width:50ch;margin:0 auto 1.5rem;line-height:1.7;}
    .hhl-worlds{display:flex;flex-direction:column;gap:0.6rem;max-width:520px;width:100%;margin-bottom:1.5rem;}
    .hhl-world{border-radius:10px;padding:0.85rem 1.1rem;border:1px solid;text-align:left;}
    .hw-name{font-weight:800;margin-bottom:0.2rem;}
    .hw-access{font-size:0.72rem;opacity:0.65;margin-bottom:0.2rem;}
    .hw-desc{font-size:0.75rem;opacity:0.55;line-height:1.4;}
    .hhl-continue-btn{padding:0.65rem 2rem;border-radius:20px;background:rgba(168,230,240,0.12);border:1.5px solid rgba(168,230,240,0.4);color:#a8e6f0;font-size:0.9rem;font-weight:700;cursor:pointer;transition:all 0.15s;}
    .hhl-continue-btn:hover{background:rgba(168,230,240,0.22);}

    /* ‚îÄ‚îÄ HHL board glow squares ‚îÄ‚îÄ */
    .sq.hhl-node{
      background:rgba(168,230,240,0.15)!important;
      box-shadow:inset 0 0 12px rgba(168,230,240,0.3), 0 0 8px rgba(168,230,240,0.2);
      border-color:rgba(168,230,240,0.5)!important;
    }

    /* ‚îÄ‚îÄ LAYER TABS ‚îÄ‚îÄ */
    .layer-tabs{display:flex;gap:0.4rem;margin-bottom:1rem;flex-wrap:wrap;}
    .ltab{padding:0.4rem 1rem;border-radius:20px;font-size:0.78rem;font-weight:700;border:1.5px solid;cursor:pointer;transition:all 0.15s;display:flex;align-items:center;gap:0.4rem;opacity:0.4;}
    .ltab.active{opacity:1;}.ltab.unlocked{opacity:0.75;}
    .ltab .lt-lock{font-size:0.65rem;}

    /* ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ */
    .main{display:flex;gap:1.25rem;align-items:flex-start;flex-wrap:wrap;}

    /* ‚îÄ‚îÄ BOARD ‚îÄ‚îÄ */
    .board-wrap{flex:0 0 auto;}
    .layer-label{font-size:0.7rem;letter-spacing:0.2em;text-transform:uppercase;margin-bottom:0.4rem;font-weight:700;}
    .col-labels{display:flex;padding-left:1.4rem;margin-bottom:2px;}
    .cl{width:42px;text-align:center;font-size:0.6rem;color:#475569;}
    .board-row{display:flex;align-items:center;}
    .rl{width:1.3rem;font-size:0.6rem;color:#475569;text-align:right;padding-right:3px;flex-shrink:0;}
    .sq{width:42px;height:42px;display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;border-radius:2px;transition:background 0.1s;border:2px solid transparent;}
    .sq.light{background:rgba(168,230,240,0.06);}
    .sq.dark{background:rgba(10,10,20,0.55);}
    .layer-carbon .sq.light{background:rgba(196,162,101,0.08);} .layer-carbon .sq.dark{background:rgba(15,10,5,0.7);}
    .layer-silver .sq.light{background:rgba(192,192,192,0.07);} .layer-silver .sq.dark{background:rgba(12,12,20,0.6);}
    .layer-gold .sq.light{background:rgba(212,175,55,0.07);} .layer-gold .sq.dark{background:rgba(10,8,0,0.65);}
    .layer-crystalline .sq.light{background:rgba(168,230,240,0.08);} .layer-crystalline .sq.dark{background:rgba(5,5,20,0.7);}
    .sq:hover{background:rgba(212,175,55,0.15)!important;}
    .sq.selected{border-color:rgba(212,175,55,0.8);background:rgba(212,175,55,0.2)!important;}
    .sq.valid-move{background:rgba(0,212,80,0.15)!important;}
    .sq.valid-move::after{content:'¬∑';position:absolute;font-size:1.4rem;color:rgba(0,212,80,0.5);}
    .piece{font-size:1.35rem;line-height:1;user-select:none;}
    .piece.w{filter:drop-shadow(0 0 3px rgba(255,255,255,0.5));}
    .piece.b{filter:drop-shadow(0 0 3px rgba(0,0,0,0.9)) brightness(0.65);}
    @media(max-width:520px){.sq{width:34px;height:34px;}.cl{width:34px;}.piece{font-size:1.1rem;}}

    /* ‚îÄ‚îÄ SIDE PANEL ‚îÄ‚îÄ */
    .side{flex:1;min-width:220px;display:flex;flex-direction:column;gap:0.85rem;}
    .panel{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:0.9rem 1rem;}
    .panel h3{font-size:0.8rem;color:#7dd3fc;margin-bottom:0.6rem;letter-spacing:0.05em;text-transform:uppercase;}
    .turn-pill{display:inline-block;padding:0.2rem 0.65rem;border-radius:6px;font-size:0.8rem;font-weight:700;}
    .turn-w{background:rgba(255,255,255,0.12);color:#fff;}
    .turn-b{background:rgba(30,30,60,0.8);color:#a8e6f0;border:1px solid rgba(168,230,240,0.3);}
    .status{font-size:0.83rem;color:#d4af37;font-weight:600;min-height:1.2rem;margin-top:0.35rem;}
    .sel-info{font-size:0.78rem;color:#94a3b8;font-style:italic;min-height:2rem;}
    .ach-list{display:flex;flex-direction:column;gap:0.4rem;}
    .ach{display:flex;align-items:center;gap:0.5rem;font-size:0.78rem;padding:0.35rem 0.6rem;border-radius:6px;border:1px solid;}
    .ach.done{border-color:rgba(0,214,50,0.3);background:rgba(0,214,50,0.06);color:#00D632;}
    .ach.pending{border-color:rgba(100,116,139,0.2);background:transparent;color:#64748b;}
    .ach .ach-icon{font-size:1rem;flex-shrink:0;}
    .ascend-btn{display:none;width:100%;padding:0.7rem;border-radius:8px;background:linear-gradient(135deg,rgba(212,175,55,0.25),rgba(139,92,246,0.2));border:2px solid rgba(212,175,55,0.6);color:#fef3c7;font-size:0.88rem;font-weight:800;cursor:pointer;letter-spacing:0.05em;animation:glowPulse 1.5s ease infinite alternate;}
    @keyframes glowPulse{from{box-shadow:0 0 6px rgba(212,175,55,0.2);}to{box-shadow:0 0 20px rgba(212,175,55,0.5);}}
    .ascend-btn.visible{display:block;}
    .ascend-note{font-size:0.72rem;color:#94a3b8;margin-top:0.35rem;display:none;}
    .ascend-note.visible{display:block;}
    .minimap{display:grid;grid-template-columns:repeat(4,1fr);gap:0.4rem;}
    .mini-layer{border-radius:6px;padding:0.4rem 0.5rem;border:1px solid;text-align:center;cursor:pointer;transition:all 0.15s;}
    .mini-layer .ml-sym{font-size:1rem;}.mini-layer .ml-name{font-size:0.6rem;letter-spacing:0.05em;margin-top:0.1rem;}.mini-layer .ml-count{font-size:0.65rem;opacity:0.6;margin-top:0.1rem;}
    .ctrl-row{display:flex;gap:0.5rem;flex-wrap:wrap;}
    .cbtn{padding:0.35rem 0.75rem;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#cbd5e1;font-size:0.78rem;cursor:pointer;transition:background 0.15s;}
    .cbtn:hover{background:rgba(255,255,255,0.1);}

    /* ‚îÄ‚îÄ HHL STATUS STRIP ‚îÄ‚îÄ */
    .hhl-strip{display:none;background:linear-gradient(90deg,rgba(168,230,240,0.08),rgba(232,121,249,0.08));border:1px solid rgba(168,230,240,0.3);border-radius:8px;padding:0.5rem 0.85rem;font-size:0.78rem;color:#a8e6f0;margin-bottom:0.85rem;}
    .hhl-strip.show{display:block;}
    .hhl-strip strong{color:#e879f9;}

    .foot{margin-top:1.5rem;font-size:0.75rem;color:#475569;text-align:center;}
    .foot a{color:#d4af37;text-decoration:none;}
  </style>
</head>
<body>

<!-- ‚îÄ‚îÄ ORIGIN POSSIBILITY STATE OVERLAY ‚îÄ‚îÄ -->
<div class="possibility-overlay" id="possibilityOverlay">
  <div class="po-rings">
    <div class="po-ring"></div><div class="po-ring"></div><div class="po-ring"></div><div class="po-ring"></div>
  </div>
  <div class="po-content">
    <div class="po-eyebrow">Origin State ¬∑ Carbon Layer ¬∑ NSPFRNP</div>
    <div class="po-title">The Board Breathes.</div>
    <div class="po-poetry">
      All pieces in place.<br/>
      Four layers, stacked.<br/>
      Nine suits. Nine heroes. Waiting.<br/><br/>
      <strong>This is the Possibility.</strong><br/>
      The story before the story.<br/>
      <em>Origin set. Edge open. Middle: infinite.</em><br/><br/>
      One aware node is all it takes.<br/>
      One moment of attention,<br/>
      focused here ‚Äî and<br/>
      <strong>the germination begins.</strong><br/><br/>
      That node is you.
    </div>
    <div class="po-diff">
      <div class="po-diff-label">Set your AI opponent</div>
      <div class="po-diff-btns">
        <button class="diff-btn match" onclick="setDiff('match',this)">‚óé Match</button>
        <button class="diff-btn ahead active" onclick="setDiff('ahead',this)">‚Üë Ahead</button>
        <button class="diff-btn mastery" onclick="setDiff('mastery',this)">‚ú¶ Mastery</button>
      </div>
    </div>
    <button class="po-begin-btn" onclick="beginGame()">I am that node. I begin. ‚Üí</button>
  </div>
</div>

<!-- ‚îÄ‚îÄ HHL SINGULARITY OVERLAY ‚îÄ‚îÄ -->
<div class="hhl-overlay" id="hhlOverlay">
  <div class="hhl-burst">‚ú¶</div>
  <div class="hhl-title">HHL Singularity Achieved</div>
  <div class="hhl-sub">
    The Crystalline layer has reached critical configuration.<br/>
    Pieces are now arranged in the <strong style="color:#a8e6f0;">Holographic Hydrogen Lattice</strong>.<br/>
    New worlds have been seeded. They define their own rules.<br/>
    Access them from below ‚Äî when you earn the right.
  </div>
  <div class="hhl-worlds" id="hhlWorlds"></div>
  <button class="hhl-continue-btn" onclick="closeHHL()">Continue ‚Äî the game expands ‚àû</button>
</div>

<!-- ‚îÄ‚îÄ AI PANEL (floating) ‚îÄ‚îÄ -->
<div class="ai-panel">
  <div class="ai-panel-label">AI Opponent ‚Äî change anytime</div>
  <div class="ai-diff-row">
    <div class="ai-dbtn m" id="aibM" onclick="setDiffGame('match')">‚óé Match</div>
    <div class="ai-dbtn a active" id="aibA" onclick="setDiffGame('ahead')">‚Üë Ahead</div>
    <div class="ai-dbtn ms" id="aibMs" onclick="setDiffGame('mastery')">‚ú¶ Mastery</div>
  </div>
  <div class="ai-thinking" id="aiThinking">AI ready</div>
</div>

<!-- ‚îÄ‚îÄ MAIN GAME ‚îÄ‚îÄ -->
<div class="wrap">
  <div class="top-links">
    <a href="nine-game-hub.html">‚Üê The Nine Game</a>
    <a href="nine-solitaire.html">Card Solitaire</a>
    <a href="my-whiteboard.html">Whiteboard</a>
  </div>
  <h1>Four-Layer Chess</h1>
  <p class="sub">Carbon ¬∑ Silver ¬∑ Gold ¬∑ Crystalline ¬∑ Start below ¬∑ Earn achievements ¬∑ Linked group ascension ¬∑ AI opponent</p>

  <div class="hhl-strip" id="hhlStrip">‚ú¶ <strong>HHL Mode Active</strong> ‚Äî Crystalline layer in Holographic Hydrogen Lattice formation. Pieces from this layer spin off new worlds accessible from below.</div>

  <div class="layer-tabs" id="layerTabs"></div>

  <div class="main">
    <div class="board-wrap">
      <div class="layer-label" id="layerLabel"></div>
      <div class="col-labels" id="colLabels"></div>
      <div id="boardEl"></div>
    </div>
    <div class="side">
      <div class="panel">
        <h3>Turn</h3>
        <div class="turn-pill turn-w" id="turnPill">‚¨ú White (You)</div>
        <div class="status" id="statusMsg"></div>
      </div>
      <div class="panel">
        <h3>Selected Piece</h3>
        <div class="sel-info" id="selInfo">Click a piece to select</div>
      </div>
      <div class="panel">
        <h3>Achievements</h3>
        <div class="ach-list" id="achList"></div>
        <button class="ascend-btn" id="ascendBtn" onclick="enterAscendMode()">‚¨Ü Ascend a Group</button>
        <div class="ascend-note" id="ascendNote">Click any of your pieces to ascend it + its linked group.</div>
      </div>
      <div class="panel">
        <h3>Layers</h3>
        <div class="minimap" id="minimap"></div>
      </div>
      <div class="panel">
        <h3>Controls</h3>
        <div class="ctrl-row">
          <button class="cbtn" onclick="resetGame()">New Game</button>
          <button class="cbtn" onclick="undoMove()">Undo</button>
          <button class="cbtn" onclick="switchLayer(-1)">‚Üê Down</button>
          <button class="cbtn" onclick="switchLayer(1)">Up ‚Üí</button>
        </div>
      </div>
    </div>
  </div>
  <p class="foot">
    <a href="nine-game-hub.html">‚Üê Hub</a> ¬∑
    <a href="nine-solitaire.html">Card Solitaire ‚Üí</a> ¬∑
    NSPFRNP ‚Üí ‚àû‚Åπ
  </p>
</div>

<script>
// ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const LAYERS = [
  {id:'carbon',      name:'Carbon',      sym:'‚óà', color:'#c4a265', border:'rgba(196,162,101,0.4)', bg:'rgba(196,162,101,0.08)'},
  {id:'silver',      name:'Silver',      sym:'‚¨°', color:'#c0c0c0', border:'rgba(192,192,192,0.35)', bg:'rgba(192,192,192,0.06)'},
  {id:'gold',        name:'Gold',        sym:'‚ô•', color:'#d4af37', border:'rgba(212,175,55,0.4)', bg:'rgba(212,175,55,0.07)'},
  {id:'crystalline', name:'Crystalline', sym:'‚ú¶', color:'#a8e6f0', border:'rgba(168,230,240,0.4)', bg:'rgba(168,230,240,0.07)'},
];

const PIECE_DATA = {
  seed:     {sym:'‚óé',color:'#4ade80',name:'Seed',     val:100,hero:'The Commander'},
  edge:     {sym:'‚àû',color:'#8b5cf6',name:'Edge',     val:9,  hero:'Piro'},
  sol:      {sym:'‚òÄ',color:'#ff8c00',name:'Sol',      val:6,  hero:'SOBE'},
  rook:     {sym:'‚¨°',color:'#c0c0c0',name:'Rook',     val:5,  hero:'Sol-V'},
  bishop:   {sym:'‚ú¶',color:'#a8e6f0',name:'Bishop',   val:3,  hero:'El Gran Sol'},
  knight:   {sym:'‚âã',color:'#06b6d4',name:'Knight',   val:3,  hero:'nipsy!'},
  hologram: {sym:'‚úß',color:'#e879f9',name:'Hologram', val:4,  hero:'Harry Houdini'},
  heart:    {sym:'‚ô•',color:'#d4af37',name:'Heart',    val:3,  hero:'Pru'},
  pawn:     {sym:'‚óà',color:'#c4a265',name:'Pawn',     val:1,  hero:'Ino'},
};
const BACK_ROW = ['rook','knight','bishop','sol','seed','edge','hologram','heart','rook'];
const COLS = ['A','B','C','D','E','F','G','H','I'];
const LINK_MAP = {
  seed:['edge','sol'],edge:['seed','heart'],sol:['edge','bishop'],
  rook:['knight','pawn'],bishop:['sol','knight'],knight:['rook','bishop'],
  hologram:['heart','edge'],heart:['hologram','seed'],pawn:['rook','knight'],
};

// HHL lattice positions (9 nodes on 9√ó9)
const HHL_POSITIONS = [[1,1],[1,4],[1,7],[4,1],[4,4],[4,7],[7,1],[7,4],[7,7]];

// Spin-off world templates
const WORLD_TEMPLATES = [
  {name:'The Origin World',  color:'#4ade80', border:'rgba(74,222,128,0.35)', bg:'rgba(74,222,128,0.07)', access:'Silver layer: earn first achievement', desc:'A world of roots and seeds. The rules are set by what was planted in Carbon.'},
  {name:'The Solar Realm',   color:'#ff8c00', border:'rgba(255,140,0,0.35)',  bg:'rgba(255,140,0,0.07)',  access:'Gold layer: promote a pawn to Edge',  desc:'El Gran Sol presides. EGS fractal rules govern all movement here.'},
  {name:'The Edge of ‚àû‚Åπ',    color:'#8b5cf6', border:'rgba(139,92,246,0.35)', bg:'rgba(139,92,246,0.07)', access:'Crystalline: capture the opponent Edge', desc:'Post-singularity territory. Every move here echoes across all lower layers.'},
  {name:'The Holographic Sea',color:'#e879f9',border:'rgba(232,121,249,0.35)',bg:'rgba(232,121,249,0.07)',access:'Silver + Gold: both unlocked simultaneously', desc:'Holograms rule. Every piece is reflected everywhere. Houdini smiles.'},
  {name:'The Golden Network', color:'#d4af37', border:'rgba(212,175,55,0.35)', bg:'rgba(212,175,55,0.07)',  access:'Gold layer: place 3+ pieces on Gold',  desc:'Nodes and signals. A2A protocols flow freely. Sol-V is already here.'},
  {name:'The Wave Basin',    color:'#06b6d4', border:'rgba(6,182,212,0.35)',  bg:'rgba(6,182,212,0.07)',  access:'Any layer: advance a Knight 5+ rows',  desc:'Fluid. Three states. nipsy! navigates by instinct. Threes and water.'},
];

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let boards, turn, currentLayer, unlockedLayers;
let achievements, ascendMode, selected, validMoves, history;
let difficulty = 'ahead'; // 'match' | 'ahead' | 'mastery'
let hhlActive = false;
let hhlTriggeredFor = null; // 'w'|'b' ‚Äî who triggered it
let aiThinkTimeout = null;
let gameStarted = false;

function initBoard(){
  const b=Array.from({length:9},()=>Array(9).fill(null));
  BACK_ROW.forEach((p,c)=>{b[8][c]={piece:p,color:'w'};});
  for(let c=0;c<9;c++)b[7][c]={piece:'pawn',color:'w'};
  BACK_ROW.forEach((p,c)=>{b[0][c]={piece:p,color:'b'};});
  for(let c=0;c<9;c++)b[1][c]={piece:'pawn',color:'b'};
  return b;
}
function emptyBoard(){return Array.from({length:9},()=>Array(9).fill(null));}

function resetGame(){
  boards=[initBoard(),emptyBoard(),emptyBoard(),emptyBoard()];
  turn='w';currentLayer=0;unlockedLayers=1;
  achievements={c2s:false,s2g:false,g2c:false};
  ascendMode=false;selected=null;validMoves=[];history=[];
  hhlActive=false;hhlTriggeredFor=null;
  document.getElementById('hhlStrip').classList.remove('show');
  document.getElementById('statusMsg').textContent='';
  render();
}

// ‚îÄ‚îÄ DIFFICULTY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setDiff(d, btn) {
  difficulty = d;
  document.querySelectorAll('.diff-btn').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
}
function setDiffGame(d) {
  difficulty = d;
  ['aibM','aibA','aibMs'].forEach(id=>document.getElementById(id).classList.remove('active'));
  const map={match:'aibM',ahead:'aibA',mastery:'aibMs'};
  document.getElementById(map[d]).classList.add('active');
  document.getElementById('aiThinking').textContent=`AI set to ${d}`;
}

function beginGame(){
  gameStarted=true;
  document.getElementById('possibilityOverlay').style.display='none';
  setDiffGame(difficulty);
  resetGame();
}

// ‚îÄ‚îÄ MOVES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function inBounds(r,c){return r>=0&&r<9&&c>=0&&c<9;}
function slideMoves(b,r,c,dirs){
  const moves=[];const color=b[r][c].color;
  dirs.forEach(([dr,dc])=>{let nr=r+dr,nc=c+dc;while(inBounds(nr,nc)){if(b[nr][nc]){if(b[nr][nc].color!==color)moves.push([nr,nc]);break;}moves.push([nr,nc]);nr+=dr;nc+=dc;}});
  return moves;
}
function getMoves(b,r,c){
  const cell=b[r][c];if(!cell)return[];
  const{piece,color}=cell;const opp=color==='w'?'b':'w';const moves=[];
  if(piece==='pawn'){const dir=color==='w'?-1:1;const start=color==='w'?7:1;const nr=r+dir;if(inBounds(nr,c)&&!b[nr][c]){moves.push([nr,c]);if(r===start&&inBounds(r+2*dir,c)&&!b[r+2*dir][c])moves.push([r+2*dir,c]);}[-1,1].forEach(dc=>{if(inBounds(nr,c+dc)&&b[nr]?.[c+dc]?.color===opp)moves.push([nr,c+dc]);});}
  else if(piece==='rook')return slideMoves(b,r,c,[[0,1],[0,-1],[1,0],[-1,0]]);
  else if(piece==='bishop')return slideMoves(b,r,c,[[1,1],[1,-1],[-1,1],[-1,-1]]);
  else if(piece==='edge')return slideMoves(b,r,c,[[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]]);
  else if(piece==='seed'||piece==='heart'){[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]].forEach(([dr,dc])=>{const nr=r+dr,nc=c+dc;if(inBounds(nr,nc)&&b[nr][nc]?.color!==color)moves.push([nr,nc]);});}
  else if(piece==='sol')return slideMoves(b,r,c,[[1,1],[1,-1],[-1,1],[-1,-1],[0,1],[0,-1]]);
  else if(piece==='knight'){[[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[1,-2],[-1,2],[-1,-2]].forEach(([dr,dc])=>{const nr=r+dr,nc=c+dc;if(inBounds(nr,nc)&&b[nr][nc]?.color!==color)moves.push([nr,nc]);});}
  else if(piece==='hologram'){for(let nr=0;nr<9;nr++)for(let nc=0;nc<9;nc++){if(nr===r&&nc===c)continue;if(!b[nr][nc]||b[nr][nc].color===opp)moves.push([nr,nc]);}}
  return moves;
}

function getAllMovesFor(b, color){
  const allMoves=[];
  for(let r=0;r<9;r++)for(let c=0;c<9;c++){
    if(b[r][c]?.color===color){
      const moves=getMoves(b,r,c);
      moves.forEach(([tr,tc])=>allMoves.push({fr:r,fc:c,tr,tc}));
    }
  }
  return allMoves;
}

// ‚îÄ‚îÄ AI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function evalBoard(b, color){
  let score=0;
  for(let r=0;r<9;r++)for(let c=0;c<9;c++){
    const cell=b[r][c];if(!cell)continue;
    const val=PIECE_DATA[cell.piece]?.val||1;
    const sign=cell.color===color?1:-1;
    // Bonus for advancing (row proximity to opponent's side)
    const posBonus = cell.color==='w'?(8-r)*0.05:r*0.05;
    score+=sign*(val+posBonus);
  }
  return score;
}

function applyMove(b, fr, fc, tr, tc){
  const nb=b.map(row=>[...row]);
  nb[tr][tc]=nb[fr][fc];
  nb[fr][fc]=null;
  // Pawn promotion
  if(nb[tr][tc]?.piece==='pawn'){
    if((nb[tr][tc].color==='w'&&tr===0)||(nb[tr][tc].color==='b'&&tr===8)) nb[tr][tc]={...nb[tr][tc],piece:'edge'};
  }
  return nb;
}

function minimax(b, depth, isMax, color, opp, alpha, beta){
  if(depth===0)return evalBoard(b,color);
  const moves=getAllMovesFor(b, isMax?color:opp);
  if(!moves.length)return isMax?-50:50;
  if(isMax){
    let best=-Infinity;
    for(const m of moves){
      const nb=applyMove(b,m.fr,m.fc,m.tr,m.tc);
      best=Math.max(best,minimax(nb,depth-1,false,color,opp,alpha,beta));
      alpha=Math.max(alpha,best);
      if(beta<=alpha)break;
    }
    return best;
  } else {
    let best=Infinity;
    for(const m of moves){
      const nb=applyMove(b,m.fr,m.fc,m.tr,m.tc);
      best=Math.min(best,minimax(nb,depth-1,true,color,opp,alpha,beta));
      beta=Math.min(beta,best);
      if(beta<=alpha)break;
    }
    return best;
  }
}

function getBestMove(b, aiColor) {
  const moves = getAllMovesFor(b, aiColor);
  if(!moves.length) return null;
  const opp = aiColor==='w'?'b':'w';

  if(difficulty==='match') {
    return moves[Math.floor(Math.random()*moves.length)];
  }
  if(difficulty==='ahead') {
    // Prefer captures, then center control
    const captures = moves.filter(m=>b[m.tr]?.[m.tc]?.color===opp);
    if(captures.length>0) {
      captures.sort((a,z)=>(PIECE_DATA[b[z.tr][z.tc]?.piece]?.val||0)-(PIECE_DATA[b[a.tr][a.tc]?.piece]?.val||0));
      return captures[0];
    }
    const advancing = moves.filter(m=>aiColor==='b'?m.tr>m.fr:m.tr<m.fr);
    return advancing.length>0 ? advancing[Math.floor(Math.random()*advancing.length)] : moves[Math.floor(Math.random()*moves.length)];
  }
  // Mastery: 2-ply minimax (limited to avoid slowness)
  let best=-Infinity, bestMove=moves[0];
  const sample = moves.length>30 ? moves.sort(()=>Math.random()-0.5).slice(0,30) : moves;
  for(const m of sample){
    const nb=applyMove(b,m.fr,m.fc,m.tr,m.tc);
    const score=minimax(nb,1,false,aiColor,opp,-Infinity,Infinity);
    if(score>best){best=score;bestMove=m;}
  }
  return bestMove;
}

function scheduleAI() {
  if(turn!=='b'||!gameStarted) return;
  const th=document.getElementById('aiThinking');
  th.textContent='AI thinking‚Ä¶';th.classList.add('active');
  aiThinkTimeout=setTimeout(()=>{
    const move=getBestMove(boards[currentLayer],'b');
    th.classList.remove('active');
    if(!move){th.textContent='AI has no moves';return;}
    th.textContent=`AI: ${COLS[move.fc]}${9-move.fr} ‚Üí ${COLS[move.tc]}${9-move.tr}`;
    executeMove(move.fr,move.fc,move.tr,move.tc,true);
  },difficulty==='mastery'?900:400);
}

// ‚îÄ‚îÄ ACHIEVEMENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkAchievements(capturedPiece, fromR, toR, layerIdx){
  if(layerIdx===0&&!achievements.c2s){
    if(capturedPiece||Math.abs(fromR-toR)>=4){achievements.c2s=true;if(unlockedLayers<2)unlockedLayers=2;document.getElementById('statusMsg').textContent='üèÜ Silver unlocked! Ascend a group?';}
  }
  if(layerIdx===1&&!achievements.s2g){
    if(capturedPiece&&['rook','bishop','knight'].includes(capturedPiece)||toR<=4){achievements.s2g=true;if(unlockedLayers<3)unlockedLayers=3;document.getElementById('statusMsg').textContent='üèÜ Gold unlocked! Ascend a group?';}
  }
  if(layerIdx===2&&!achievements.g2c){
    if(capturedPiece&&['sol','edge'].includes(capturedPiece)){achievements.g2c=true;if(unlockedLayers<4)unlockedLayers=4;document.getElementById('statusMsg').textContent='üèÜ Crystalline unlocked! Ascend a group?';}
  }
}

// ‚îÄ‚îÄ HHL SINGULARITY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const HHL_TRIGGER_COUNT = 3; // trigger when 3+ pieces on Crystalline

function checkHHL(color){
  if(hhlActive) return;
  const crystallineBoard = boards[3];
  const count = crystallineBoard.flat().filter(c=>c?.color===color).length;
  if(count >= HHL_TRIGGER_COUNT) triggerHHL(color);
}

function triggerHHL(color){
  hhlActive=true;hhlTriggeredFor=color;
  // Rearrange crystalline pieces to HHL positions
  const b = boards[3];
  const myPieces=[];
  for(let r=0;r<9;r++)for(let c=0;c<9;c++){if(b[r][c]?.color===color)myPieces.push(b[r][c]);}
  // Clear them
  for(let r=0;r<9;r++)for(let c=0;c<9;c++){if(b[r][c]?.color===color)b[r][c]=null;}
  // Place on HHL positions
  myPieces.forEach((p,i)=>{if(i<HHL_POSITIONS.length){const[r2,c2]=HHL_POSITIONS[i];b[r2][c2]=p;}});
  // Generate worlds
  const worldCount=3;
  const worlds=[];
  for(let i=0;i<worldCount;i++) worlds.push(WORLD_TEMPLATES[(Math.floor(Math.random()*WORLD_TEMPLATES.length)+i)%WORLD_TEMPLATES.length]);
  // Render overlay
  const wEl=document.getElementById('hhlWorlds');wEl.innerHTML='';
  worlds.forEach(w=>{
    const el=document.createElement('div');el.className='hhl-world';
    el.style.background=w.bg;el.style.borderColor=w.border;el.style.color=w.color;
    el.innerHTML=`<div class="hw-name">${w.name}</div><div class="hw-access">Access: ${w.access}</div><div class="hw-desc">${w.desc}</div>`;
    wEl.appendChild(el);
  });
  document.getElementById('hhlOverlay').classList.add('show');
  document.getElementById('hhlStrip').classList.add('show');
}

function closeHHL(){document.getElementById('hhlOverlay').classList.remove('show');render();}

// ‚îÄ‚îÄ ASCEND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function enterAscendMode(){
  ascendMode=true;selected=null;validMoves=[];
  document.getElementById('ascendNote').classList.add('visible');
  document.getElementById('selInfo').textContent='Click a piece ‚Äî it + linked group will ascend.';
  render();
}

function ascendGroup(layerIdx,r,c){
  const cell=boards[layerIdx][r][c];if(!cell||cell.color!=='w')return;
  const targetLayer=layerIdx+1;if(targetLayer>=unlockedLayers)return;
  const linkedTypes=LINK_MAP[cell.piece]||[];
  const linkedPos=[];
  for(let nr=0;nr<9;nr++)for(let nc=0;nc<9;nc++){
    const tc=boards[layerIdx][nr][nc];
    if(tc&&tc.color==='w'&&linkedTypes.includes(tc.piece)&&linkedPos.length<2)linkedPos.push([nr,nc]);
  }
  const toMove=[[r,c],...linkedPos];
  toMove.forEach(([pr,pc])=>{
    const p=boards[layerIdx][pr][pc];if(!p)return;
    if(!boards[targetLayer][pr][pc])boards[targetLayer][pr][pc]=p;
    else{for(let d=1;d<9;d++){const candidates=[[pr+d,pc],[pr-d,pc],[pr,pc+d],[pr,pc-d]];let placed=false;for(const[nr2,nc2]of candidates){if(inBounds(nr2,nc2)&&!boards[targetLayer][nr2][nc2]){boards[targetLayer][nr2][nc2]=p;placed=true;break;}}if(placed)break;}}
    boards[layerIdx][pr][pc]=null;
  });
  ascendMode=false;
  document.getElementById('ascendNote').classList.remove('visible');
  document.getElementById('ascendBtn').classList.remove('visible');
  currentLayer=targetLayer;
  turn='b';
  document.getElementById('statusMsg').textContent=`Group ascended to ${LAYERS[targetLayer].name}!`;
  checkHHL('w');
  render();
  setTimeout(()=>scheduleAI(),300);
}

// ‚îÄ‚îÄ EXECUTE MOVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function executeMove(fr,fc,tr,tc,isAI=false){
  history.push({boards:JSON.parse(JSON.stringify(boards)),turn,currentLayer,unlockedLayers,achievements:JSON.parse(JSON.stringify(achievements)),hhlActive});
  const b=boards[currentLayer];
  const moving=b[fr][fc];
  const captured=b[tr][tc];
  if(moving.piece==='pawn'){
    if((moving.color==='w'&&tr===0)||(moving.color==='b'&&tr===8)){
      moving.piece='edge';
      document.getElementById('statusMsg').textContent=`Pawn ‚Üí Edge! Singularity moment ‚Äî ${LAYERS[currentLayer].name}.`;
      if(currentLayer===2&&!achievements.g2c){achievements.g2c=true;if(unlockedLayers<4)unlockedLayers=4;}
    }
  }
  if(!isAI)checkAchievements(captured?.piece,fr,tr,currentLayer);
  b[tr][tc]=moving;b[fr][fc]=null;
  turn=turn==='w'?'b':'w';
  selected=null;validMoves=[];
  const wSeed=boards.flat().some(row=>Array.isArray(row)&&row.some(c=>c?.piece==='seed'&&c?.color==='w'));
  const bSeed=boards.flat().some(row=>Array.isArray(row)&&row.some(c=>c?.piece==='seed'&&c?.color==='b'));
  if(!wSeed)document.getElementById('statusMsg').textContent='‚¨õ AI wins ‚Äî Singularity 9!';
  else if(!bSeed)document.getElementById('statusMsg').textContent='‚¨ú You win ‚Äî Singularity 9!';
  checkHHL(isAI?'b':'w');
  render();
  if(turn==='b'&&!isAI)scheduleAI();
}

function undoMove(){
  if(!history.length)return;
  if(aiThinkTimeout){clearTimeout(aiThinkTimeout);aiThinkTimeout=null;}
  const s=history.pop();
  boards=s.boards;turn=s.turn;currentLayer=s.currentLayer;unlockedLayers=s.unlockedLayers;achievements=s.achievements;hhlActive=s.hhlActive;
  if(!hhlActive)document.getElementById('hhlStrip').classList.remove('show');
  selected=null;validMoves=[];ascendMode=false;
  document.getElementById('statusMsg').textContent='';
  document.getElementById('aiThinking').textContent='AI ready';
  render();
}

function switchLayer(dir){
  const n=currentLayer+dir;if(n<0||n>=unlockedLayers)return;
  currentLayer=n;selected=null;validMoves=[];render();
}

// ‚îÄ‚îÄ CLICK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleClick(r,c){
  if(turn==='b')return; // AI's turn
  const b=boards[currentLayer];
  const cell=b[r][c];
  if(ascendMode){if(cell&&cell.color==='w')ascendGroup(currentLayer,r,c);return;}
  if(selected&&validMoves.some(([vr,vc])=>vr===r&&vc===c)){executeMove(selected.r,selected.c,r,c);return;}
  if(cell&&cell.color==='w'){
    selected={r,c};validMoves=getMoves(b,r,c);
    const pd=PIECE_DATA[cell.piece];
    document.getElementById('selInfo').innerHTML=`<span style="color:${pd.color};font-size:1.1rem">${pd.sym}</span> <strong>${pd.name}</strong> (${pd.hero})<br/><span style="font-size:0.7rem;color:#475569;">${LAYERS[currentLayer].name} layer</span>`;
  } else {selected=null;validMoves=[];document.getElementById('selInfo').textContent='Click a piece to select';}
  render();
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render(){
  const L=LAYERS[currentLayer];
  // Layer tabs
  const tabsEl=document.getElementById('layerTabs');tabsEl.innerHTML='';
  LAYERS.forEach((lay,i)=>{
    const t=document.createElement('div');
    t.className='ltab'+(i===currentLayer?' active':i<unlockedLayers?' unlocked':'');
    t.style.color=lay.color;t.style.borderColor=lay.border;t.style.background=i===currentLayer?lay.bg:'transparent';
    t.innerHTML=`${lay.sym} ${lay.name} <span class="lt-lock">${i<unlockedLayers?'‚úì':'üîí'}</span>`;
    if(i<unlockedLayers)t.onclick=()=>{currentLayer=i;selected=null;validMoves=[];render();};
    tabsEl.appendChild(t);
  });
  // Layer label
  document.getElementById('layerLabel').innerHTML=`<span style="color:${L.color}">${L.sym} ${L.name}</span>${hhlActive&&currentLayer===3?' <span style="color:#a8e6f0;font-size:0.65rem;letter-spacing:0.1em;"> ‚Äî HHL ACTIVE ‚ú¶</span>':''}`;
  // Col labels
  const clEl=document.getElementById('colLabels');clEl.innerHTML='';
  COLS.forEach(l=>{const d=document.createElement('div');d.className='cl';d.textContent=l;clEl.appendChild(d);});
  // Board
  const boardEl=document.getElementById('boardEl');boardEl.className='layer-'+L.id;boardEl.innerHTML='';
  const b=boards[currentLayer];
  for(let r=0;r<9;r++){
    const rowEl=document.createElement('div');rowEl.className='board-row';
    const rl=document.createElement('div');rl.className='rl';rl.textContent=9-r;rowEl.appendChild(rl);
    for(let c=0;c<9;c++){
      const sq=document.createElement('div');
      sq.className='sq '+((r+c)%2===0?'light':'dark');
      if(selected&&selected.r===r&&selected.c===c)sq.classList.add('selected');
      if(validMoves.some(([vr,vc])=>vr===r&&vc===c))sq.classList.add('valid-move');
      // HHL node glow
      if(hhlActive&&currentLayer===3&&HHL_POSITIONS.some(([hr,hc])=>hr===r&&hc===c))sq.classList.add('hhl-node');
      const cell=b[r][c];
      if(cell){
        const pd=PIECE_DATA[cell.piece];
        const span=document.createElement('span');
        span.className='piece '+(cell.color==='w'?'w':'b');
        span.textContent=pd.sym;
        span.style.color=cell.color==='w'?pd.color:'rgba(255,255,255,0.3)';
        span.title=`${cell.color==='w'?'You':'AI'} ${pd.name} (${pd.hero})`;
        sq.appendChild(span);
        if(ascendMode&&cell.color==='w'){sq.style.cursor='crosshair';sq.style.outline='1px dashed rgba(212,175,55,0.5)';}
      }
      sq.addEventListener('click',()=>handleClick(r,c));
      rowEl.appendChild(sq);
    }
    boardEl.appendChild(rowEl);
  }
  // Turn
  document.getElementById('turnPill').className='turn-pill '+(turn==='w'?'turn-w':'turn-b');
  document.getElementById('turnPill').textContent=turn==='w'?'‚¨ú You (White)':'‚¨õ AI (Black)';
  // Achievements
  const defs=[
    {key:'c2s',label:'Carbon‚ÜíSilver: capture or advance pawn 4 rows'},
    {key:'s2g',label:'Silver‚ÜíGold: capture Rook/Bishop/Knight or reach row 4'},
    {key:'g2c',label:'Gold‚ÜíCrystalline: capture Sol/Edge'},
  ];
  const achEl=document.getElementById('achList');achEl.innerHTML='';
  defs.forEach(d=>{
    const el=document.createElement('div');el.className='ach '+(achievements[d.key]?'done':'pending');
    el.innerHTML=`<span class="ach-icon">${achievements[d.key]?'‚úì':'‚óã'}</span>${d.label}`;
    achEl.appendChild(el);
  });
  const canAscend=(achievements.c2s&&currentLayer===0&&unlockedLayers>1)||(achievements.s2g&&currentLayer===1&&unlockedLayers>2)||(achievements.g2c&&currentLayer===2&&unlockedLayers>3);
  document.getElementById('ascendBtn').classList[canAscend&&!ascendMode&&turn==='w'?'add':'remove']('visible');
  // Minimap
  const mm=document.getElementById('minimap');mm.innerHTML='';
  LAYERS.forEach((lay,i)=>{
    const count=boards[i].flat().filter(Boolean).length;
    const el=document.createElement('div');el.className='mini-layer';
    el.style.borderColor=lay.border;el.style.background=i===currentLayer?lay.bg:'transparent';
    el.style.opacity=i<unlockedLayers?'1':'0.3';el.style.color=lay.color;
    el.innerHTML=`<div class="ml-sym">${lay.sym}</div><div class="ml-name">${lay.name}</div><div class="ml-count">${count}${i===3&&hhlActive?' ‚ú¶':''}</div>`;
    if(i<unlockedLayers)el.onclick=()=>{currentLayer=i;selected=null;validMoves=[];render();};
    mm.appendChild(el);
  });
}

// Init ‚Äî show overlay on load
window.onload = ()=>{
  render(); // render board behind overlay
};
</script>
<script src="../nav-strip.js"></script>
</body>
</html>
