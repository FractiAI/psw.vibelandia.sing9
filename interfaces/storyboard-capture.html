<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Storyboard capture · Upload | NSPFRNP</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: #0f0c08;
      color: #f5f5f5;
      min-height: 100vh;
      padding: 1rem;
      padding-top: calc(1rem + env(safe-area-inset-top));
    }
    .wrap { max-width: 820px; margin: 0 auto; }
    h1 { font-size: 1.25rem; color: #d4af37; margin-bottom: 0.5rem; }
    .sub { font-size: 0.85rem; color: #a3a3a3; margin-bottom: 1rem; }
    .phase-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #d4af37;
      margin-bottom: 0.35rem;
    }
    .stack-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    @media (min-width: 640px) { .stack-grid { grid-template-columns: repeat(3, 1fr); } }
    .stack-btn {
      padding: 0.6rem 0.75rem;
      font-size: 0.8rem;
      text-align: left;
      border: 2px solid rgba(212, 175, 55, 0.35);
      border-radius: 8px;
      background: rgba(20, 18, 14, 0.9);
      color: #e5e5e5;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .stack-btn:hover { border-color: rgba(212, 175, 55, 0.6); background: rgba(40, 36, 28, 0.95); }
    .stack-btn.active { border-color: #d4af37; background: rgba(212, 175, 55, 0.15); color: #d4af37; }
    .stack-btn.crystal-gold { border-left: 4px solid #d4af37; }
    .stack-btn.crystal-silver { border-left: 4px solid #c0c0c0; }
    .stack-btn.crystal-crystalline { border-left: 4px solid #e0f7ff; }
    .stack-btn.crystal-carbon { border-left: 4px solid #4a4a4a; }
    .voice-row { margin-bottom: 1rem; }
    .voice-btn {
      padding: 0.6rem 1.2rem;
      font-size: 0.9rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .voice-btn.record { background: #b91c1c; color: #fff; }
    .voice-btn.record.recording { background: #dc2626; box-shadow: 0 0 12px rgba(220, 38, 38, 0.6); }
    .transcript-box {
      min-height: 2.5rem;
      padding: 0.6rem;
      margin-top: 0.5rem;
      background: rgba(0,0,0,0.4);
      border-radius: 8px;
      border: 1px solid rgba(212, 175, 55, 0.25);
      font-size: 0.9rem;
      color: #e5e5e5;
    }
    .upload-zone {
      border: 2px dashed rgba(212, 175, 55, 0.5);
      border-radius: 12px;
      padding: 2rem;
      text-align: center;
      margin-bottom: 1rem;
      background: rgba(20, 18, 14, 0.5);
      transition: border-color 0.2s, background 0.2s;
    }
    .upload-zone:hover, .upload-zone.dragover { border-color: #d4af37; background: rgba(212, 175, 55, 0.08); }
    .upload-zone p { margin-bottom: 0.75rem; color: #a3a3a3; font-size: 0.9rem; }
    .btn-choose {
      padding: 1rem 2rem;
      font-size: 1.1rem;
      font-weight: 700;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      background: linear-gradient(135deg, #d4af37, #b8860b);
      color: #0a0a0a;
      box-shadow: 0 0 20px rgba(212, 175, 55, 0.4);
    }
    .btn-choose:hover { box-shadow: 0 0 28px rgba(212, 175, 55, 0.5); }
    input[type="file"] { display: none; }
    .preview-img {
      max-width: 100%;
      max-height: 240px;
      margin-top: 1rem;
      border-radius: 8px;
      border: 2px solid rgba(212, 175, 55, 0.3);
      object-fit: contain;
    }
    .status { font-size: 0.85rem; color: #a3a3a3; margin-top: 0.5rem; }
    .status.error { color: #f87171; }
    .status.ok { color: #22d3ee; }
    .capture-count { font-size: 0.9rem; color: #d4af37; margin-bottom: 0.5rem; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Storyboard capture</h1>
    <p class="sub">Choose a stack, add an optional voice note, then pick or drop image(s). Each image is saved with seed/edge/abstract and executive prompt. No camera needed.</p>
    <p class="phase-label">Order: Sets & surfaces → Main storyline → Supporting decks</p>
    <p class="capture-count" id="captureCount">Added: 0</p>
    <div class="stack-grid" id="stackGrid"></div>
    <div class="voice-row">
      <button type="button" class="voice-btn record" id="btnVoice">Record voice note</button>
      <div class="transcript-box" id="transcriptBox" aria-live="polite">(optional executive producer note)</div>
    </div>
    <div class="upload-zone" id="uploadZone">
      <p>Choose image(s) or drag and drop here</p>
      <button type="button" class="btn-choose" id="btnChoose">Choose image(s)</button>
      <input type="file" id="fileInput" accept="image/*" multiple />
      <div id="previewContainer"></div>
    </div>
    <p class="status" id="status"></p>
  </div>

  <script>
(function () {
  var STACKS = [
    { id: 1, name: 'Now playing', phase: 'Sets & surfaces', crystal: 'gold', short: 'now-playing' },
    { id: 2, name: 'Full play deck · Main story', phase: 'Main storyline', crystal: 'gold', short: 'full-play' },
    { id: 3, name: 'Crystalline', phase: 'Supporting decks', crystal: 'crystalline', short: 'crystalline' },
    { id: 4, name: 'Biological enriching characters', phase: 'Supporting decks', crystal: 'silver', short: 'enriching' },
    { id: 5, name: 'Genuine hearts · Golden hearts', phase: 'Supporting decks', crystal: 'gold', short: 'genuine-hearts' },
    { id: 6, name: 'Disingenuous · fake carbon', phase: 'Supporting decks', crystal: 'carbon', short: 'disingenuous' },
    { id: 7, name: 'Destination · versions · playlists', phase: 'Supporting decks', crystal: 'silver', short: 'destination' }
  ];

  var stackGrid = document.getElementById('stackGrid');
  var fileInput = document.getElementById('fileInput');
  var btnChoose = document.getElementById('btnChoose');
  var uploadZone = document.getElementById('uploadZone');
  var transcriptBox = document.getElementById('transcriptBox');
  var statusEl = document.getElementById('status');
  var captureCountEl = document.getElementById('captureCount');
  var previewContainer = document.getElementById('previewContainer');
  var btnVoice = document.getElementById('btnVoice');

  var selectedStack = STACKS[0];
  var sequenceByStack = {};
  var totalAdded = 0;
  var recognition = null;
  var isRecording = false;
  var transcript = '';

  function setStatus(msg, isError) {
    statusEl.textContent = msg;
    statusEl.classList.toggle('error', !!isError);
    statusEl.classList.toggle('ok', !isError && msg);
  }

  function renderStackButtons() {
    stackGrid.innerHTML = '';
    STACKS.forEach(function (stack) {
      var btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'stack-btn crystal-' + stack.crystal + (selectedStack && selectedStack.id === stack.id ? ' active' : '');
      btn.textContent = stack.name;
      btn.addEventListener('click', function () {
        selectedStack = stack;
        renderStackButtons();
      });
      stackGrid.appendChild(btn);
    });
  }

  function getNextIndex(stackId) {
    sequenceByStack[stackId] = (sequenceByStack[stackId] || 0) + 1;
    return sequenceByStack[stackId];
  }

  function processFile(file) {
    if (!file.type.startsWith('image/')) {
      setStatus('Skipped (not an image): ' + file.name, true);
      return;
    }
    var stack = selectedStack;
    var num = getNextIndex(stack.id);
    totalAdded += 1;
    var baseName = 'storyboard-seed-' + String(stack.id) + '-' + stack.short + '-' + String(num).padStart(2, '0');
    var epPrompt = (transcriptBox.textContent || '').trim();
    if (epPrompt === '(optional executive producer note)') epPrompt = undefined;
    var seed = 'Stack ' + stack.id + ' · ' + stack.name;
    var edge = '30-second fill';
    var abstract = epPrompt || 'Executive Producer prompt aligns to crystal: ' + stack.crystal;

    var reader = new FileReader();
    reader.onload = function () {
      var dataUrl = reader.result;
      var a = document.createElement('a');
      a.href = dataUrl;
      a.download = baseName + '.png';
      a.click();

      var meta = {
        stackId: stack.id,
        stackName: stack.name,
        phase: stack.phase,
        crystal: stack.crystal,
        sequence: num,
        seed: seed,
        edge: edge,
        abstract: abstract,
        executivePrompt: epPrompt,
        originalFilename: file.name,
        timestamp: new Date().toISOString()
      };
      var blob = new Blob([JSON.stringify(meta, null, 2)], { type: 'application/json' });
      var url = URL.createObjectURL(blob);
      var a2 = document.createElement('a');
      a2.href = url;
      a2.download = baseName + '-meta.json';
      a2.click();
      URL.revokeObjectURL(url);
    };
    reader.readAsDataURL(file);
    captureCountEl.textContent = 'Added: ' + totalAdded;
    setStatus('Saved ' + baseName + '. Add more or change stack and add again.', false);
  }

  function handleFiles(files) {
    if (!files || !files.length) return;
    var i = 0;
    function next() {
      if (i >= files.length) {
        previewContainer.innerHTML = '';
        return;
      }
      var file = files[i];
      i += 1;
      processFile(file);
      var img = document.createElement('img');
      img.className = 'preview-img';
      img.alt = file.name;
      previewContainer.innerHTML = '';
      previewContainer.appendChild(img);
      var r = new FileReader();
      r.onload = function () { img.src = r.result; };
      r.readAsDataURL(file);
      setTimeout(next, 400);
    }
    next();
  }

  btnChoose.addEventListener('click', function () { fileInput.click(); });
  fileInput.addEventListener('change', function () {
    handleFiles(this.files);
    this.value = '';
  });

  uploadZone.addEventListener('dragover', function (e) {
    e.preventDefault();
    uploadZone.classList.add('dragover');
  });
  uploadZone.addEventListener('dragleave', function () {
    uploadZone.classList.remove('dragover');
  });
  uploadZone.addEventListener('drop', function (e) {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    handleFiles(e.dataTransfer.files);
  });

  function setupVoice() {
    var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      transcriptBox.textContent = 'Voice input not supported in this browser. Type your note above or leave blank.';
      return;
    }
    recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = 'en-US';
    recognition.onresult = function (e) {
      var r = e.results[e.resultIndex];
      if (r.isFinal) transcript += r[0].transcript + ' ';
      transcriptBox.textContent = transcript || '(optional executive producer note)';
    };
    recognition.onerror = function () { };
  }

  btnVoice.addEventListener('click', function () {
    if (!recognition) return;
    if (isRecording) {
      recognition.stop();
      isRecording = false;
      btnVoice.classList.remove('recording');
      btnVoice.textContent = 'Record voice note';
      return;
    }
    transcript = (transcriptBox.textContent || '').trim();
    if (transcript === '(optional executive producer note)') transcript = '';
    recognition.start();
    isRecording = true;
    btnVoice.classList.add('recording');
    btnVoice.textContent = 'Stop recording';
  });

  renderStackButtons();
  setupVoice();
})();
  </script>
</body>
</html>
